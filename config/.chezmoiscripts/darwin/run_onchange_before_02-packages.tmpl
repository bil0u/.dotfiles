#!/usr/bin/env bash
set -euo pipefail

source "{{ .chezmoi.sourceDir }}/.chezmoiscripts/.utils.sh"

filename "packages"

if ! command -v brew &>/dev/null; then
  {{ if eq .host.arch "arm64" -}}
  eval "$(/opt/homebrew/bin/brew shellenv)"
  {{ else -}}
  eval "$(/usr/local/bin/brew shellenv)"
  {{ end -}}
fi

action "Installing packages ..."
brew bundle --no-lock --file=/dev/stdin <<EOF
# Taps
{{ range (.homebrew.taps | uniq) -}}
tap '{{ . }}'
{{ end -}}
# Formulaes
{{ range (.homebrew.formulaes | uniq) -}}
brew '{{ . }}'
{{ end -}}
# Casks
{{ range (.homebrew.casks | uniq) -}}
cask '{{ . }}'
{{ end -}}
# Mac AppStore
{{ range (.homebrew.mas | uniq) -}}
mas '{{ .name }}', id: {{ .id }}
{{ end -}}
EOF
